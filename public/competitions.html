<!doctype html>
<html>
<head><meta charset="utf-8"><title>Competitions</title></head>
<body>
  <h2>Open Competitions</h2>
  <div id="list"></div>
  <hr>
  <div>
    <label>Quantity (tickets @ £0.25 each):</label>
    <input id="qty" type="range" min="1" max="1000" value="1" oninput="qv.innerText=this.value; total.innerText=(this.value*0.25).toFixed(2)">
    <b id="qv">1</b>
    <div>Total: £<b id="total">0.25</b></div>
    <button id="buy" disabled>Buy with Stripe</button>
  </div>
<script>
let current = null;
async function load(){
  const r = await fetch('/api/competitions');
  const comps = await r.json();
  const list = document.getElementById('list'); list.innerHTML='';
  comps.forEach(c=>{
    const d=document.createElement('div');
    d.style.margin='12px 0';
    d.innerHTML = `<b>${c.title}</b> — ${c.description||''}<br>Tickets: ${c.total_tickets} • Price: £${(c.price_pence/100).toFixed(2)} • Instant Wins: ${c.instant_win_count}`;
    d.onclick=()=>{ current=c; document.getElementById('buy').disabled=false; };
    list.appendChild(d);
  });
}
document.getElementById('buy').onclick = async ()=>{
  if(!current) return alert('Pick a competition first');
  const quantity = parseInt(document.getElementById('qty').value,10);
  const r = await fetch('/api/checkout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({competitionId: current.id, quantity})});
  const data = await r.json();
  if(data.url) location.href = data.url; else alert('Checkout error');
};
load();
</script>
</body>
</html>
